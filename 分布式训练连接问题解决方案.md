# 分布式训练连接问题解决方案

## 错误信息

```
[W socket.cpp:697] [c10d] The client socket has failed to connect to [chensong]:8535 
(system error: 10049 - The requested address is not valid in its context.)
```

## 问题原因

1. **主机名解析问题**：Windows 系统尝试连接到主机名 `chensong`，但无法正确解析
2. **错误代码 10049**：Windows 特定的网络错误，表示地址无效
3. **端口配置**：端口 8535 可能配置错误（代码默认使用 8514）

## 解决方案

### 方案1：修改训练脚本（推荐）

确保训练脚本中使用 `localhost` 或 `127.0.0.1` 作为 `MASTER_ADDR`：

**批处理文件（.bat）：**
```bat
set MASTER_ADDR=localhost
set MASTER_PORT=8514
```

**PowerShell 脚本（.ps1）：**
```powershell
$MASTER_ADDR = "localhost"
$MASTER_PORT = 8514
```

**命令行参数：**
```bash
--master_addr=localhost --master_port=8514
```

### 方案2：检查并修改环境变量

如果环境变量中设置了 `MASTER_ADDR`，确保它使用正确的值：

```cmd
# 检查当前设置
echo %MASTER_ADDR%

# 设置为 localhost
set MASTER_ADDR=localhost
set MASTER_PORT=8514
```

### 方案3：检查端口占用

确保端口 8514（或你使用的端口）未被占用：

```cmd
# 检查端口占用
netstat -ano | findstr :8514

# 如果被占用，可以：
# 1. 关闭占用端口的程序
# 2. 或者使用其他端口（如 8515, 8516 等）
```

### 方案4：使用代码自动修复（已实现）

代码已经更新，会自动检测并修复 Windows 上的主机名问题：

```python
# 如果 MASTER_ADDR 是主机名，自动替换为 localhost
if platform.system() == 'Windows':
    if os.environ.get('MASTER_ADDR', '').lower() not in ['localhost', '127.0.0.1']:
        os.environ['MASTER_ADDR'] = 'localhost'
```

## 常见问题

### Q1: 为什么不能使用主机名？

**A:** Windows 的网络栈对主机名解析的支持不如 Linux，特别是在某些网络配置下。使用 `localhost` 或 `127.0.0.1` 更可靠。

### Q2: 单机训练应该使用什么地址？

**A:** 单机训练（单机单GPU或多GPU）应该使用：
- `localhost`（推荐）
- `127.0.0.1`
- 不要使用主机名或实际IP地址

### Q3: 多机训练应该使用什么地址？

**A:** 多机训练时：
- 主节点（rank=0）：使用主节点的实际IP地址（如 `192.168.1.100`）
- 从节点：使用主节点的IP地址
- 确保所有节点能够互相访问

### Q4: 如何检查连接是否正常？

**A:** 可以尝试：
```cmd
# 测试端口是否可访问
telnet localhost 8514

# 或者使用 PowerShell
Test-NetConnection -ComputerName localhost -Port 8514
```

## 推荐的训练脚本配置

### 单机单GPU训练

```bat
set MASTER_ADDR=localhost
set MASTER_PORT=8514
set RANK=0
set WORLD_SIZE=1
```

### 单机多GPU训练（4个GPU）

```bat
set MASTER_ADDR=localhost
set MASTER_PORT=8514
# RANK 和 WORLD_SIZE 由 torch.distributed.launch 自动设置
```

### 命令行启动示例

```cmd
python -m torch.distributed.launch ^
    --nproc_per_node=1 ^
    --nnodes=1 ^
    --node_rank=0 ^
    --master_addr=localhost ^
    --master_port=8514 ^
    -- cn_clip/training/main.py [其他参数...]
```

## 验证修复

修复后，应该看到：
- 不再出现 `10049` 错误
- 成功连接到 `localhost:8514`
- 训练正常开始

如果仍有问题，检查：
1. 防火墙是否阻止了端口
2. 是否有其他程序占用端口
3. 网络配置是否正确

