# 训练启动说明

## 问题
运行训练命令时遇到 `USE_LIBUV` 错误，这是因为 Windows 上的 PyTorch 分布式训练需要禁用 libuv 支持。

## 解决方案

### 方法1：使用批处理文件（推荐）
直接双击运行 `run_training.bat`，或在命令提示符中运行：
```cmd
run_training.bat
```

### 方法2：手动激活环境后运行
1. 打开 **Anaconda Prompt** 或 **命令提示符**
2. 激活环境并设置环境变量：
```cmd
conda activate stable-diffusion-webui
set USE_LIBUV=0
```
3. 运行训练命令：
```cmd
python -m torch.distributed.launch --nproc_per_node=1 --nnodes=1 --node_rank=0 --master_addr=localhost --master_port=8514 -- cn_clip/training/main.py --train-data=datapath/datasets/MUGE/lmdb/train --val-data=datapath/datasets/MUGE/lmdb/valid --num-workers=4 --valid-num-workers=4 --resume=datapath/pretrained_weights/clip_cn_vit-b-16.pt --reset-data-offset --reset-optimizer --logs=datapath/experiments/ --name=muge_finetune_vit-b-16_roberta-base_bs48_1gpu --save-step-frequency=999999 --save-epoch-frequency=1 --log-interval=10 --report-training-batch-acc --context-length=52 --warmup=100 --batch-size=48 --valid-batch-size=48 --valid-step-interval=1000 --valid-epoch-interval=1 --lr=3e-06 --wd=0.001 --max-epochs=1 --vision-model=ViT-B-16 --use-augment --grad-checkpointing --text-model=RoBERTa-wwm-ext-base-chinese
```

### 方法3：使用 PowerShell 脚本
在 PowerShell 中运行：
```powershell
.\run_training.ps1
```

## 重要提示
1. **`--` 分隔符**：在 `--master_port=8514` 后面必须有 `--`，用于分隔 launch 参数和训练脚本参数
2. **`node_rank`**：当只有1个节点时，必须设置为 `0`
3. **环境变量**：必须在运行 Python 命令之前设置 `USE_LIBUV=0`

## 查看训练日志
训练日志保存在：
```
datapath/experiments/muge_finetune_vit-b-16_roberta-base_bs48_1gpu/
```

查看最新日志：
```powershell
Get-ChildItem datapath\experiments\muge_finetune_vit-b-16_roberta-base_bs48_1gpu\*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content -Tail 50 -Wait
```

